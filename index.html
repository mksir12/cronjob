<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cron Job Manager</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Cron Job Manager</h1>

    <form id="createForm" class="card">
      <h2>Create Cron Job</h2>
      <label>Job URL
        <input type="text" id="jobUrl" placeholder="https://example.com" required>
      </label>
      <label>Password
        <input type="text" id="jobPassword" placeholder="Enter 5-digit password" required>
      </label>
      <button type="submit">Create Job (Every 5 mins)</button>
    </form>

    <div class="card">
      <h2>Existing Cron Jobs</h2>
      <button onclick="loadJobs()">Refresh</button>
      <div id="jobsList" class="job-list scrollable"></div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const API_BASE = 'https://api.cron-job.org';
    const API_KEY = '8EH3QCKn++aUd4SGWabbE4nb667AvXjfYhR55rQbvBE=';

    const ADMIN_CODE = 'OGGYADMIN123'; // <<< SECRET ADMIN PASSWORD

    const createForm = document.getElementById('createForm');
    const jobUrlInput = document.getElementById('jobUrl');
    const jobPasswordInput = document.getElementById('jobPassword');
    const jobsList = document.getElementById('jobsList');

    loadJobs();

    createForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const jobUrl = jobUrlInput.value.trim();
      const password = jobPasswordInput.value.trim();

      if (!jobUrl || !password || password.length < 3) {
        alert('Please enter both URL and a valid password.');
        return;
      }

      const payload = {
        job: {
          url: jobUrl,
          enabled: true,
          saveResponses: false,
          title: `pw:${password}`,
          schedule: {
            timezone: "UTC",
            expiresAt: 0,
            hours: [-1],
            mdays: [-1],
            minutes: [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55],
            months: [-1],
            wdays: [-1]
          }
        }
      };

      try {
        const res = await fetch(`${API_BASE}/jobs`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        alert(res.ok ? 'Job Created!' : 'Error: ' + JSON.stringify(data));
        if (res.ok) {
          jobUrlInput.value = '';
          jobPasswordInput.value = '';
          loadJobs();
        }
      } catch (err) {
        console.error('Error creating job:', err);
      }
    });

    window.loadJobs = async () => {
      const jobsRes = await fetch(`${API_BASE}/jobs`, {
        headers: { 'Authorization': `Bearer ${API_KEY}` }
      });

      const data = await jobsRes.json();
      jobsList.innerHTML = '';

      if (!data.jobs || data.jobs.length === 0) {
        jobsList.innerHTML = '<p>No jobs found.</p>';
        return;
      }

      for (const job of data.jobs) {
        const storedPassword = job.title?.startsWith('pw:') ? job.title.slice(3) : '';

        const div = document.createElement('div');
        div.className = 'job';
        div.innerHTML = `
          <p><strong>ID:</strong> ${job.jobId}</p>
          <p><strong>URL:</strong> ${job.url}</p>
          <p><strong>Minutes:</strong> ${JSON.stringify(job.schedule.minutes)}</p>
          <div class="job-actions">
            <input type="password" placeholder="Enter password to delete" id="delpw-${job.jobId}">
            <button onclick="deleteJob('${job.jobId}', '${storedPassword}')">Delete</button>
          </div>
        `;
        jobsList.appendChild(div);
      }
    };

    window.deleteJob = async (jobId, correctPassword) => {
      const inputPassword = document.getElementById(`delpw-${jobId}`).value.trim();

      if (inputPassword === correctPassword || inputPassword === ADMIN_CODE) {
        await fetch(`${API_BASE}/jobs/${jobId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${API_KEY}` }
        });
        alert('Job deleted.');
        loadJobs();
      } else {
        alert('Incorrect password. Contact admin.');
      }
    };
  });
  </script>
</body>
</html>
